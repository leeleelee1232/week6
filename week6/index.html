<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>14주</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .custom-toggle {
      position: fixed;
      left: 50px;
      z-index: 1000;
      background: white;
      padding: 5px 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    #timeline {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    input[type="range"] { flex: 1; }
    #playPauseButton {
      padding: 8px 12px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #playPauseButton.paused { background-color: #f44336; }
    #timeDisplay {
      font-size: 14px;
      color: #333;
      min-width: 120px;
    }
    #windyFrameContainer {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 9999;
      display: none;
      background: white;
    }
    #windyFrame { width: 100%; height: 100%; border: none; display: block; }
    #windyCloseBtn {
      position: absolute; top: 10px; right: 10px;
      z-index: 10000;
      background: rgba(0, 0, 0, 0.5); color: white;
      border: none; border-radius: 4px;
      padding: 8px 12px; cursor: pointer;
      font-size: 16px; font-weight: bold;
    }
    #forecastPanel {
      position: fixed;
      z-index: 1001;
      width: 320px;
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: none;
    }
    #forecastHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
    }
    #forecastContent {
      padding: 10px;
    }
    .forecastDayGroup {
      margin-bottom: 12px;
    }
    .forecastDayGroup h4 {
      margin: 8px 0;
      font-size: 15px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 2px;
    }
    .forecastItem {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      gap: 10px;
      font-size: 14px;
    }
    .forecastItem img {
      width: 30px; height: 30px;
    }
    #forecastToggleBtn {
      position: fixed;
      left: 50px;
      top: 130px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      z-index: 1002;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <label class="custom-toggle" style="top: 10px;"><input type="checkbox" id="radarToggle" /> 비 레이더 보기</label>
  <label class="custom-toggle" style="top: 50px;"><input type="checkbox" id="cloudToggle" /> 구름 보기</label>
  <label class="custom-toggle" style="top: 90px;"><input type="checkbox" id="windyToggle" /> Windy 바람 보기</label>
  <button id="forecastToggleBtn">현재 위치 날씨 예보</button>

  <div id="timeline">
    <div id="timeDisplay">시간: </div>
    <input type="range" id="timeRange" min="0" max="0" value="0" step="1" />
    <button id="playPauseButton">재생</button>
  </div>

  <div id="windyFrameContainer">
    <button id="windyCloseBtn" title="닫기">×</button>
    <iframe id="windyFrame" src="https://embed.windy.com/embed2.html?lat=36.5&lon=127.8&zoom=7&level=surface&overlay=wind" frameborder="0"></iframe>
  </div>

  <div id="forecastPanel">
    <div id="forecastHeader">
      <span id="locationName">위치 불러오는 중...</span>
    </div>
    <div id="forecastContent">로딩 중...</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([36.5, 127.8], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
    }).addTo(map);

    const openWeatherApiKey = "278cba3ce47dbfe50d7711a72cdcd566";

    let radarFrames = [], currentFrame = 0, radarLayer, animationInterval, isPlaying = false, radarDataLoaded = false, cloudLayer = null;

    async function fetchRadarData() {
      const res = await fetch("https://api.rainviewer.com/public/weather-maps.json");
      const data = await res.json();
      radarFrames = data.radar.past.slice(-12).concat(data.radar.nowcast);
      document.getElementById("timeRange").max = radarFrames.length - 1;
      showRadarFrame(currentFrame);
    }

    function showRadarFrame(index) {
      if (radarLayer) map.removeLayer(radarLayer);
      const frame = radarFrames[index];
      radarLayer = L.tileLayer(`https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/2/1_1.png`, { opacity: 0.6 });
      radarLayer.addTo(map);
      const time = new Date(frame.time * 1000);
      document.getElementById("timeDisplay").textContent = "시간: " + time.toLocaleString("ko-KR");
    }

    function startAnimation() {
      animationInterval = setInterval(() => {
        showRadarFrame(currentFrame);
        currentFrame = (currentFrame + 1) % radarFrames.length;
        document.getElementById("timeRange").value = currentFrame;
      }, 3000);
      isPlaying = true;
      document.getElementById("playPauseButton").textContent = "정지";
      document.getElementById("playPauseButton").classList.add("paused");
    }

    function stopAnimation() {
      clearInterval(animationInterval);
      isPlaying = false;
      document.getElementById("playPauseButton").textContent = "재생";
      document.getElementById("playPauseButton").classList.remove("paused");
    }

    document.getElementById("timeRange").addEventListener("input", e => {
      currentFrame = parseInt(e.target.value);
      showRadarFrame(currentFrame);
    });

    document.getElementById("playPauseButton").addEventListener("click", () => {
      isPlaying ? stopAnimation() : startAnimation();
    });

    document.getElementById("radarToggle").addEventListener("change", async function () {
      const timeline = document.getElementById("timeline");
      if (this.checked) {
        timeline.style.display = "flex";
        if (!radarDataLoaded) {
          await fetchRadarData();
          radarDataLoaded = true;
        } else {
          showRadarFrame(currentFrame);
        }
      } else {
        timeline.style.display = "none";
        stopAnimation();
        if (radarLayer) {
          map.removeLayer(radarLayer);
          radarLayer = null;
        }
      }
    });

    document.getElementById("cloudToggle").addEventListener("change", function () {
      if (this.checked) {
        if (!cloudLayer) {
          cloudLayer = L.tileLayer(`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${openWeatherApiKey}`, { opacity: 0.9 });
          cloudLayer.addTo(map);
        }
      } else {
        if (cloudLayer) {
          map.removeLayer(cloudLayer);
          cloudLayer = null;
        }
      }
    });

    document.getElementById("windyToggle").addEventListener("change", () => {
      const container = document.getElementById("windyFrameContainer");
      container.style.display = windyToggle.checked ? "block" : "none";
    });

    document.getElementById("windyCloseBtn").addEventListener("click", () => {
      document.getElementById("windyFrameContainer").style.display = "none";
      document.getElementById("windyToggle").checked = false;
    });

    document.getElementById("forecastToggleBtn").addEventListener("click", async () => {
      const panel = document.getElementById("forecastPanel");
      const btn = document.getElementById("forecastToggleBtn");

      // 열려있으면 닫기
      if (panel.style.display === "block") {
        panel.style.display = "none";
        return;
      }

      panel.style.display = "block";
      const rect = btn.getBoundingClientRect();
      panel.style.left = `${rect.left}px`;
      panel.style.top = `${rect.bottom + 5}px`;

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${openWeatherApiKey}&lang=kr`);
        const data = await res.json();

        document.getElementById("locationName").textContent = `${data.city.name}, ${data.city.country}`;

        const grouped = {};
        data.list.forEach(item => {
          const date = new Date(item.dt * 1000);
          const dateStr = date.toLocaleDateString("ko-KR");
          if (!grouped[dateStr]) grouped[dateStr] = [];
          grouped[dateStr].push(item);
        });

        const html = Object.entries(grouped).map(([date, items]) => {
          const rows = items.map(item => {
            const hour = new Date(item.dt * 1000).getHours();
            const icon = `https://openweathermap.org/img/wn/${item.weather[0].icon}.png`;
            const temp = Math.round(item.main.temp);
            const desc = item.weather[0].description;
            return `<div class="forecastItem"><span>${hour}시</span><img src="${icon}" /><span>${temp}°C</span><span>${desc}</span></div>`;
          }).join("");
          return `<div class="forecastDayGroup"><h4>${date}</h4>${rows}</div>`;
        }).join("");

        document.getElementById("forecastContent").innerHTML = html;
      }, err => {
        document.getElementById("forecastContent").textContent = "위치 정보를 불러올 수 없습니다.";
      });
    });

    document.getElementById("timeline").style.display = "none";
  </script>
</body>
</html>
